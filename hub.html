<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>APEX HUB — Trading Intelligence</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#080c10;--bg2:#0d1117;--bg3:#111820;
    --border:#1e2a38;--border2:#243040;
    --text:#cdd9e5;--text2:#8b9ab0;--text3:#4a5568;
    --green:#00e5a0;--green2:#00b87a;
    --red:#ff4d6d;--blue:#3b9eff;
    --yellow:#f5c842;--orange:#ff8c42;--purple:#a78bfa;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;min-height:100vh;overflow-x:hidden;}
  body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(59,158,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(59,158,255,0.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0;}
  .container{max-width:1680px;margin:0 auto;padding:0 24px;position:relative;z-index:1;}

  /* HEADER */
  header{border-bottom:1px solid var(--border);padding:13px 0;position:sticky;top:0;background:rgba(8,12,16,0.97);backdrop-filter:blur(12px);z-index:200;}
  .header-inner{display:flex;align-items:center;justify-content:space-between;}
  .logo{display:flex;align-items:center;gap:12px;}
  .logo-mark{width:34px;height:34px;border:2px solid var(--green);display:flex;align-items:center;justify-content:center;font-family:'Space Mono',monospace;font-size:13px;color:var(--green);position:relative;}
  .logo-mark::before{content:'';position:absolute;inset:3px;background:var(--green);opacity:0.08;}
  .logo-text{font-size:17px;font-weight:800;letter-spacing:0.08em;}
  .logo-text span{color:var(--green);}
  .header-meta{display:flex;align-items:center;gap:18px;font-family:'Space Mono',monospace;font-size:10px;color:var(--text3);}
  .live-dot{display:flex;align-items:center;gap:6px;color:var(--green);}
  .live-dot::before{content:'';width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 2s infinite;}
  @keyframes pulse{0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(0,229,160,0.4)}50%{opacity:.7;box-shadow:0 0 0 4px rgba(0,229,160,0)}}
  .header-actions{display:flex;gap:5px;}
  .btn{padding:6px 12px;font-family:'Space Mono',monospace;font-size:10px;border:1px solid var(--border2);background:transparent;color:var(--text2);cursor:pointer;letter-spacing:0.05em;transition:all 0.2s;}
  .btn:hover{border-color:var(--green);color:var(--green);}
  .btn.active{border-color:var(--green);color:var(--green);background:rgba(0,229,160,0.05);}
  .weekend-badge{padding:3px 9px;background:rgba(245,200,66,0.08);border:1px solid rgba(245,200,66,0.2);font-size:9px;font-family:'Space Mono',monospace;color:var(--yellow);}

  /* ASSET BAR */
  .asset-bar-wrap{border-bottom:1px solid var(--border);background:var(--bg2);}
  .asset-bar{display:flex;gap:4px;overflow-x:auto;scrollbar-width:none;padding:9px 0;}
  .asset-bar::-webkit-scrollbar{display:none;}
  .asset-pill{padding:5px 13px;border:1px solid var(--border);background:var(--bg);font-family:'Space Mono',monospace;font-size:10px;color:var(--text2);cursor:pointer;white-space:nowrap;transition:all 0.2s;display:flex;align-items:center;gap:7px;}
  .asset-pill:hover{border-color:var(--border2);color:var(--text);}
  .asset-pill.active{border-color:var(--green);color:var(--green);background:rgba(0,229,160,0.05);}
  .asset-pill.active.bear{border-color:var(--red);color:var(--red);background:rgba(255,77,109,0.05);}
  .asset-badge{font-size:8px;padding:1px 5px;}
  .badge-bull{background:rgba(0,229,160,0.1);color:var(--green);}
  .badge-bear{background:rgba(255,77,109,0.1);color:var(--red);}
  .badge-neutral{background:rgba(139,154,176,0.1);color:var(--text2);}
  .tf-mini{font-size:8px;color:var(--text3);border-left:1px solid var(--border);padding-left:7px;}

  /* VIEWS */
  .view{display:none;}.view.active{display:block;}

  /* MAIN GRID */
  .main-grid{display:grid;grid-template-columns:294px 1fr 284px;gap:13px;padding:14px 0;}

  /* PANEL */
  .panel{background:var(--bg2);border:1px solid var(--border);padding:16px;}
  .panel-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:13px;padding-bottom:11px;border-bottom:1px solid var(--border);}
  .panel-title{font-size:10px;font-weight:700;letter-spacing:0.12em;color:var(--text2);text-transform:uppercase;display:flex;align-items:center;gap:7px;}
  .panel-title-dot{width:6px;height:6px;border-radius:50%;}

  /* TF ALIGNMENT */
  .tf-alignment{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px;margin-bottom:12px;}
  .tf-col{background:var(--bg3);border:1px solid var(--border);padding:11px 8px;text-align:center;position:relative;overflow:hidden;}
  .tf-col::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
  .tf-col.bull::before{background:var(--green);}
  .tf-col.bear::before{background:var(--red);}
  .tf-col.neutral::before{background:var(--text3);}
  .tf-col-role{font-size:7px;letter-spacing:0.1em;color:var(--text3);font-family:'Space Mono',monospace;margin-bottom:5px;text-transform:uppercase;}
  .tf-col-tf{font-size:18px;font-weight:800;font-family:'Space Mono',monospace;}
  .tf-col-score{font-size:9px;font-family:'Space Mono',monospace;margin-top:3px;color:var(--text2);}
  .tf-col-status{font-size:8px;font-family:'Space Mono',monospace;margin-top:5px;}

  /* ALIGNMENT BAR */
  .alignment-bar{display:flex;align-items:center;gap:9px;padding:9px 12px;margin-bottom:12px;border:1px solid var(--border);background:var(--bg3);}
  .alignment-label{font-size:9px;font-family:'Space Mono',monospace;color:var(--text2);flex:1;}
  .alignment-dots{display:flex;gap:4px;}
  .alignment-dot{width:9px;height:9px;border-radius:50%;}
  .alignment-result{font-size:11px;font-weight:700;font-family:'Space Mono',monospace;}

  /* SCORE */
  .score-main{text-align:center;padding:14px 0 10px;}
  .score-number{font-size:56px;font-weight:800;line-height:1;font-family:'Space Mono',monospace;}
  .score-label{font-size:9px;letter-spacing:0.15em;color:var(--text2);margin-top:3px;}
  .score-bar-wrap{margin:10px 0 3px;height:4px;background:var(--bg3);}
  .score-bar-fill{height:100%;transition:width 0.6s ease;}
  .score-indicators{display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-top:10px;}
  .score-item{padding:7px 9px;background:var(--bg3);border:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
  .score-item-label{font-size:8px;color:var(--text2);font-family:'Space Mono',monospace;}
  .score-item-val{font-size:9px;font-family:'Space Mono',monospace;font-weight:700;}

  /* GAUGE */
  .prob-gauge{display:flex;align-items:center;gap:9px;padding:9px 11px;background:var(--bg3);border:1px solid var(--border);margin-bottom:5px;}
  .gauge-label{font-size:8px;color:var(--text2);font-family:'Space Mono',monospace;flex:1;}
  .gauge-track{flex:2;height:4px;background:var(--bg);border:1px solid var(--border);position:relative;}
  .gauge-fill{height:100%;}
  .gauge-val{font-size:12px;font-weight:700;font-family:'Space Mono',monospace;min-width:36px;text-align:right;}

  /* ANALYZE BTN */
  .analyze-btn{width:100%;padding:12px;background:transparent;border:1px solid var(--green);color:var(--green);font-family:'Syne',sans-serif;font-size:11px;font-weight:700;letter-spacing:0.1em;cursor:pointer;text-transform:uppercase;transition:all 0.3s;position:relative;overflow:hidden;margin-top:9px;}
  .analyze-btn::before{content:'';position:absolute;inset:0;background:var(--green);opacity:0;transition:opacity 0.3s;}
  .analyze-btn:hover::before{opacity:0.07;}
  .analyze-btn span{position:relative;z-index:1;}
  .analyze-btn.loading{border-color:var(--yellow);color:var(--yellow);}
  .analyze-btn.blocked{border-color:var(--text3);color:var(--text3);cursor:not-allowed;}

  /* SIGNAL */
  .signal-hero{background:var(--bg3);border:1px solid var(--border);padding:18px;margin-bottom:11px;position:relative;overflow:hidden;}
  .signal-hero::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
  .signal-hero.bull::before{background:linear-gradient(90deg,transparent,var(--green),transparent);}
  .signal-hero.bear::before{background:linear-gradient(90deg,transparent,var(--red),transparent);}
  .signal-direction{display:flex;align-items:center;gap:13px;margin-bottom:14px;}
  .signal-badge{padding:6px 16px;font-size:15px;font-weight:800;letter-spacing:0.1em;border-width:2px;border-style:solid;}
  .signal-badge.buy{border-color:var(--green);color:var(--green);background:rgba(0,229,160,0.05);}
  .signal-badge.sell{border-color:var(--red);color:var(--red);background:rgba(255,77,109,0.05);}
  .signal-meta{font-size:9px;font-family:'Space Mono',monospace;color:var(--text2);display:flex;flex-direction:column;gap:3px;}
  .signal-meta strong{color:var(--yellow);font-size:11px;}
  .signal-price-block{margin-left:auto;text-align:right;}
  .current-price{font-size:24px;font-weight:800;font-family:'Space Mono',monospace;}
  .price-change{font-size:10px;font-family:'Space Mono',monospace;margin-top:2px;}
  .levels-grid{display:grid;gap:7px;margin-bottom:8px;}
  .levels-4{grid-template-columns:1fr 1fr 1fr 1fr;}
  .levels-3{grid-template-columns:1fr 1fr 1fr;}
  .level-card{padding:10px 9px;background:var(--bg);border:1px solid var(--border);position:relative;}
  .level-card::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%;}
  .level-card.entry::before{background:var(--blue);}
  .level-card.stop::before{background:var(--red);}
  .level-card.tp1::before{background:rgba(0,229,160,0.35);}
  .level-card.tp2::before{background:rgba(0,229,160,0.65);}
  .level-card.tp3::before{background:var(--green);}
  .level-card.rr::before{background:var(--purple);}
  .level-card.trail::before{background:var(--yellow);}
  .level-label{font-size:7px;letter-spacing:0.12em;color:var(--text3);text-transform:uppercase;margin-bottom:4px;font-family:'Space Mono',monospace;}
  .level-price{font-size:13px;font-weight:700;font-family:'Space Mono',monospace;}
  .level-sub{font-size:7px;color:var(--text3);margin-top:3px;font-family:'Space Mono',monospace;}
  .analysis-block{background:var(--bg);border:1px solid var(--border);padding:13px;margin-bottom:9px;}
  .analysis-block-title{font-size:8px;letter-spacing:0.1em;color:var(--text3);text-transform:uppercase;margin-bottom:7px;font-family:'Space Mono',monospace;display:flex;align-items:center;gap:7px;}
  .analysis-block-title::after{content:'';flex:1;height:1px;background:var(--border);}
  .analysis-text{font-size:11px;line-height:1.7;color:var(--text2);}
  .analysis-text strong{color:var(--text);}
  .bull{color:var(--green);}.bear{color:var(--red);}.warn{color:var(--yellow);}
  .telegram-block{background:#0a1825;border:1px solid #1a3550;padding:13px;position:relative;}
  .telegram-header{display:flex;align-items:center;gap:7px;margin-bottom:9px;font-size:9px;color:var(--blue);font-family:'Space Mono',monospace;}
  .telegram-content{font-family:'Space Mono',monospace;font-size:10px;line-height:1.9;color:#a8c8e8;white-space:pre-line;}
  .tg-copy-btn{position:absolute;top:10px;right:10px;padding:3px 8px;background:transparent;border:1px solid #1a3550;color:var(--blue);font-size:8px;font-family:'Space Mono',monospace;cursor:pointer;transition:all 0.2s;}
  .tg-copy-btn:hover{background:rgba(59,158,255,0.1);}

  /* INDICATORS */
  .ind-row{padding:9px 0;border-bottom:1px solid var(--border);}
  .ind-row:last-child{border-bottom:none;}
  .ind-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;}
  .ind-name{font-size:8px;color:var(--text2);font-family:'Space Mono',monospace;letter-spacing:0.05em;}
  .ind-status{font-size:8px;font-family:'Space Mono',monospace;font-weight:700;padding:2px 6px;}
  .ind-tf-row{display:flex;gap:5px;margin-bottom:5px;}
  .ind-tf-badge{font-size:7px;font-family:'Space Mono',monospace;padding:2px 5px;border:1px solid var(--border);color:var(--text3);cursor:pointer;transition:all 0.15s;}
  .ind-tf-badge.active-tf{border-color:var(--blue);color:var(--blue);background:rgba(59,158,255,0.06);}
  .ind-tf-badge.bull-tf{border-color:var(--green);color:var(--green);background:rgba(0,229,160,0.06);}
  .ind-tf-badge.bear-tf{border-color:var(--red);color:var(--red);background:rgba(255,77,109,0.06);}
  .ind-metrics{display:flex;gap:9px;flex-wrap:wrap;}
  .ind-metric{font-size:8px;font-family:'Space Mono',monospace;color:var(--text3);}
  .ind-metric span{color:var(--text2);}

  /* BOTTOM ROW */
  .bottom-row{display:grid;grid-template-columns:294px 1fr 284px;gap:13px;padding-bottom:20px;}
  .history-item{padding:8px 0;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;}
  .history-item:last-child{border-bottom:none;}
  .history-dir{width:36px;text-align:center;font-size:8px;font-weight:700;font-family:'Space Mono',monospace;padding:3px 0;}
  .history-info{flex:1;}
  .history-asset{font-size:10px;font-weight:700;}
  .history-tf{font-size:7px;color:var(--text3);font-family:'Space Mono',monospace;}
  .history-result{font-size:9px;font-family:'Space Mono',monospace;}
  .alert-item{padding:8px 10px;border-left:2px solid var(--border);margin-bottom:6px;background:var(--bg3);}
  .alert-item.premium{border-left-color:var(--green);}
  .alert-item.warning{border-left-color:var(--yellow);}
  .alert-item.info{border-left-color:var(--blue);}
  .alert-title{font-size:10px;font-weight:700;margin-bottom:2px;}
  .alert-desc{font-size:8px;color:var(--text2);font-family:'Space Mono',monospace;}
  .alert-time{font-size:7px;color:var(--text3);font-family:'Space Mono',monospace;margin-top:2px;}

  /* SETTINGS */
  .settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:13px;padding:14px 0;}
  .settings-card{background:var(--bg2);border:1px solid var(--border);padding:16px;}
  .settings-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;padding-bottom:11px;border-bottom:1px solid var(--border);}
  .settings-card-title{font-size:10px;font-weight:700;letter-spacing:0.08em;display:flex;align-items:center;gap:8px;}
  .asset-config-row{display:grid;grid-template-columns:130px 1fr 1fr 1fr 70px 52px;gap:7px;align-items:center;padding:9px 0;border-bottom:1px solid var(--border);font-size:10px;}
  .asset-config-row:last-child{border-bottom:none;}
  .asset-config-row.header{font-size:8px;color:var(--text3);font-family:'Space Mono',monospace;letter-spacing:0.08em;text-transform:uppercase;padding-bottom:7px;}
  .config-select{background:var(--bg3);border:1px solid var(--border2);color:var(--text);font-family:'Space Mono',monospace;font-size:10px;padding:5px 7px;cursor:pointer;width:100%;appearance:none;outline:none;}
  .config-select:focus{border-color:var(--blue);}
  .config-input{background:var(--bg3);border:1px solid var(--border2);color:var(--text);font-family:'Space Mono',monospace;font-size:10px;padding:5px 7px;width:100%;outline:none;}
  .config-input:focus{border-color:var(--blue);}
  .toggle-wrap{display:flex;align-items:center;justify-content:center;}
  .toggle{width:30px;height:15px;border-radius:8px;background:var(--border2);position:relative;cursor:pointer;transition:background 0.2s;border:none;outline:none;}
  .toggle.on{background:var(--green2);}
  .toggle::after{content:'';position:absolute;top:2px;left:2px;width:11px;height:11px;border-radius:50%;background:white;transition:transform 0.2s;}
  .toggle.on::after{transform:translateX(15px);}
  .asset-name-cell{font-weight:700;font-family:'Space Mono',monospace;font-size:10px;}
  .add-asset-row{display:flex;align-items:center;gap:9px;padding:11px 0;margin-top:3px;border-top:1px solid var(--border);}
  .add-asset-row input{flex:1;background:var(--bg3);border:1px solid var(--border2);color:var(--text);font-family:'Space Mono',monospace;font-size:10px;padding:6px 9px;outline:none;}
  .add-asset-row input:focus{border-color:var(--green);}
  .btn-add{border-color:var(--green);color:var(--green);}
  .btn-add:hover{background:rgba(0,229,160,0.05);}
  .global-setting-row{display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--border);}
  .global-setting-row:last-child{border-bottom:none;}
  .global-setting-label{font-size:11px;color:var(--text2);}
  .global-setting-sub{font-size:8px;color:var(--text3);font-family:'Space Mono',monospace;margin-top:2px;}
  .global-setting-ctrl{display:flex;align-items:center;gap:7px;}
  .divider{height:1px;background:var(--border);margin:11px 0;}
  .scroll-area{max-height:270px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--border2) transparent;}
  .flex-row{display:flex;align-items:center;gap:7px;}
  .mt8{margin-top:8px;}
  .tag{display:inline-block;padding:2px 6px;font-size:8px;font-family:'Space Mono',monospace;letter-spacing:0.05em;}
  .tag-green{background:rgba(0,229,160,0.1);color:var(--green);border:1px solid rgba(0,229,160,0.2);}
  .tag-red{background:rgba(255,77,109,0.1);color:var(--red);border:1px solid rgba(255,77,109,0.2);}
  .tag-blue{background:rgba(59,158,255,0.1);color:var(--blue);border:1px solid rgba(59,158,255,0.2);}
  .tag-yellow{background:rgba(245,200,66,0.1);color:var(--yellow);border:1px solid rgba(245,200,66,0.2);}
</style>
</head>
<body>

<header>
  <div class="container">
    <div class="header-inner">
      <div class="logo">
        <div class="logo-mark">Λ</div>
        <div class="logo-text">APEX <span>HUB</span></div>
      </div>
      <div class="header-meta">
        <div class="live-dot" id="clockDot">LIVE</div>
          <div style="display:flex;align-items:center;gap:6px;font-family:'Space Mono',monospace;font-size:10px;">
            <span id="connectionDot" style="width:6px;height:6px;border-radius:50%;background:var(--yellow);display:inline-block;"></span>
            <span id="connectionLabel" style="color:var(--yellow);">CONECTANDO...</span>
          </div>
        <span id="clock">—</span>
        <span id="globalStats" style="color:var(--text3);font-size:9px;"></span>
        <span class="weekend-badge">⚠ WEEKEND MODE</span>
      </div>
      <div class="header-actions">
        <button class="btn active" onclick="showView('dashboard',this)">DASHBOARD</button>
        <button class="btn" onclick="showView('settings',this)">⚙ CONFIG ATIVOS</button>
        <button class="btn" onclick="showView('history',this)">HISTÓRICO</button>
        <button class="btn">TELEGRAM</button>
      </div>
    </div>
  </div>
</header>

<div class="asset-bar-wrap">
  <div class="container">
    <div class="asset-bar" id="assetBar"></div>
  </div>
</div>

<!-- ══ DASHBOARD ══ -->
<div class="view active" id="view-dashboard">
  <div class="container">
    <div class="main-grid">

      <!-- LEFT -->
      <div>
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title"><div class="panel-title-dot" style="background:var(--red)"></div>TF ALIGNMENT</div>
            <span class="tag tag-red" id="alignTag">ALINHADO BEAR</span>
          </div>
          <div class="tf-alignment" id="tfAlignment"></div>
          <div class="alignment-bar">
            <span class="alignment-label">ALINHAMENTO PRINCIPAL + CONF.</span>
            <div class="alignment-dots" id="alignDots"></div>
            <span class="alignment-result" id="alignResult">3/3 ✓</span>
          </div>
          <div class="divider"></div>
          <div class="score-main">
            <div class="score-number" id="scoreNumber" style="color:var(--text3);">—</div>
            <div class="score-label" id="scoreLabel">/ 5 PONTOS — AGUARDANDO</div>
            <div class="score-bar-wrap"><div class="score-bar-fill" id="scoreBarFill" style="width:0%;background:var(--text3);"></div></div>
          </div>
          <div class="score-indicators" id="scoreItems">
            <div class="score-item"><span class="score-item-label">SD Zone</span><span class="score-item-val" style="color:var(--text3);">–</span></div>
            <div class="score-item"><span class="score-item-label">KEO Sinal</span><span class="score-item-val" style="color:var(--text3);">–</span></div>
            <div class="score-item"><span class="score-item-label">MM Kernel</span><span class="score-item-val" style="color:var(--text3);">–</span></div>
            <div class="score-item"><span class="score-item-label">Osc Matrix</span><span class="score-item-val" style="color:var(--text3);">–</span></div>
            <div class="score-item" style="grid-column:1/-1;"><span class="score-item-label">Stoch RSI</span><span class="score-item-val" style="color:var(--text3);">– aguardando</span></div>
          </div>
          <div style="margin-top:11px;">
            <div class="prob-gauge"><span class="gauge-label">PROB. APEX</span><div class="gauge-track"><div class="gauge-fill" id="probFill" style="width:0%;background:var(--text3);"></div></div><span class="gauge-val" id="probValue" style="color:var(--text2);">—</span></div>
          </div>
          <button class="analyze-btn" id="analyzeBtn" onclick="triggerAnalysis()"><span>⚡ ACIONAR ANÁLISE APEX</span></button>
        </div>
      </div>

      <!-- CENTER -->
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title"><div class="panel-title-dot" style="background:var(--red)"></div><span id="signalPanelTitle">ANÁLISE ATIVA — BTC/USDT</span></div>
          <div class="flex-row"><span class="tag tag-yellow">WEEKEND</span><span class="tag tag-red" id="signalTFTag">4H · OB SELL</span></div>
        </div>
        <div class="signal-hero bear" id="signalHero">
          <div class="signal-direction">
            <div class="signal-badge sell" id="signalBadge">▼ SHORT</div>
            <div class="signal-meta">
              <strong id="signalAsset">OB SELL ⭐ — Caminho Livre</strong>
              <span>Score: <span id="signalScore"><strong>—</strong></span> &nbsp;|&nbsp;
              <span id="signalProbTag" style="display:none;color:var(--green);border:1px solid rgba(0,229,160,0.3);padding:1px 5px;font-size:8px;">PROB —%</span>
              <span id="signalPathTag" style="display:none;color:var(--yellow);border:1px solid rgba(245,200,66,0.3);padding:1px 5px;font-size:8px;">⭐ PATH CLEAR</span></span>
              <span>Principal: <span style="color:var(--text);" id="heroTFP">4H</span> &nbsp;|&nbsp; Conf: <span style="color:var(--text);" id="heroTFC">1H ✓</span> &nbsp;|&nbsp; Entrada: <span style="color:var(--text);" id="heroTFE">15m</span></span>
            </div>
            <div class="signal-price-block">
              <div class="current-price" id="currentPrice">—</div>
              <div class="price-change" id="weekendBadge" style="display:none;color:var(--yellow);">⚠ WEEKEND MODE</div>
            </div>
          </div>
          <div class="levels-grid levels-4">
            <div class="level-card entry"><div class="level-label">ENTRADA</div><div class="level-price" style="color:var(--blue);" id="levelEntry">—</div><div class="level-sub">preço execução</div></div>
            <div class="level-card stop"><div class="level-label">STOP</div><div class="level-price" style="color:var(--red);" id="levelStop">—</div><div class="level-sub">invalidação</div></div>
            <div class="level-card tp1"><div class="level-label">TP 1</div><div class="level-price" style="color:rgba(0,229,160,0.55);" id="levelTP1">—</div><div class="level-sub">alvo parcial</div></div>
            <div class="level-card tp2"><div class="level-label">TP 2</div><div class="level-price" style="color:rgba(0,229,160,0.78);" id="levelTP2">—</div><div class="level-sub">alvo principal</div></div>
          </div>
          <div class="levels-grid levels-3">
            <div class="level-card tp3"><div class="level-label">TP 3</div><div class="level-price" style="color:var(--green);" id="levelTP3">—</div><div class="level-sub">extensão</div></div>
            <div class="level-card rr"><div class="level-label">R/R</div><div class="level-price" style="color:var(--purple);" id="levelRR">—</div><div class="level-sub">risco retorno</div></div>
            <div class="level-card trail"><div class="level-label">ANÁLISE</div><div class="level-price" style="color:var(--yellow);font-size:10px;" id="levelBias">—</div><div class="level-sub">viés Claude</div></div>
          </div>
        </div>
        <div class="scroll-area">
          <div class="analysis-block">
            <div class="analysis-block-title">Estrutura & Liquidez SMC</div>
            <div class="analysis-text" id="analysisEstrutura">Aguardando sinal do indicador...</div>
          </div>
          <div class="analysis-block">
            <div class="analysis-block-title">Microestrutura · Money Flow · Kernel</div>
            <div class="analysis-text" id="analysisMicro">—</div>
          </div>
          <div class="analysis-block">
            <div class="analysis-block-title">Gestão de Risco</div>
            <div class="analysis-text" id="analysisRisco">—</div>
          </div>
          <div class="analysis-block">
            <div class="analysis-block-title">Confluências Detectadas</div>
            <div id="confluenceList"><div style="color:var(--text3);font-size:10px;">Aguardando análise...</div></div>
          </div>
          <div class="analysis-block">
            <div class="analysis-block-title">Alertas de Risco</div>
            <div id="alertsList"></div>
          </div>
          <div class="telegram-block">
            <div class="telegram-header">✈ RESUMO TELEGRAM</div>
            <button class="tg-copy-btn" onclick="copyTG()">COPIAR</button>
            <div class="telegram-content" id="tgContent">Aguardando sinal...</div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Indicators -->
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title"><div class="panel-title-dot" style="background:var(--blue)"></div>INDICADORES</div>
          <span style="font-size:8px;color:var(--text3);font-family:'Space Mono',monospace;" id="indTFLabel">Principal: 4H</span>
        </div>
        <div class="ind-row">
          <div class="ind-header"><span class="ind-name">01 · MTF SD ZONES</span><span class="ind-status" id="indStatus1" style="color:var(--text3);background:rgba(139,154,176,0.08);">AGUARD.</span></div>
          <div class="ind-tf-row" id="ind1"></div>
          <div class="ind-metrics"><div class="ind-metric" id="indMetric1">—</div></div>
        </div>
        <div class="ind-row">
          <div class="ind-header"><span class="ind-name">02 · RAH KEO v7</span><span class="ind-status" id="indStatus2" style="color:var(--text3);background:rgba(139,154,176,0.08);">AGUARD.</span></div>
          <div class="ind-tf-row" id="ind2"></div>
          <div class="ind-metrics"><div class="ind-metric" id="indMetric2">—</div></div>
        </div>
        <div class="ind-row">
          <div class="ind-header"><span class="ind-name">03 · MM V4 KERNEL</span><span class="ind-status" id="indStatus3" style="color:var(--text3);background:rgba(139,154,176,0.08);">AGUARD.</span></div>
          <div class="ind-tf-row" id="ind3"></div>
          <div class="ind-metrics"><div class="ind-metric" id="indMetric3">—</div></div>
        </div>
        <div class="ind-row">
          <div class="ind-header"><span class="ind-name">04 · OSC MATRIX</span><span class="ind-status" id="indStatus4" style="color:var(--text3);background:rgba(139,154,176,0.08);">AGUARD.</span></div>
          <div class="ind-tf-row" id="ind4"></div>
          <div class="ind-metrics"><div class="ind-metric" id="indMetric4">—</div></div>
        </div>
        <div class="ind-row">
          <div class="ind-header"><span class="ind-name">05 · STOCH RSI</span><span class="ind-status" id="indStatus5" style="color:var(--text3);background:rgba(139,154,176,0.08);">AGUARD.</span></div>
          <div class="ind-tf-row" id="ind5"></div>
          <div class="ind-metrics"><div class="ind-metric" id="indMetric5">—</div></div>
        </div>
      </div>
    </div>

    <!-- BOTTOM -->
    <div class="bottom-row">
      <div class="panel">
        <div class="panel-header"><div class="panel-title"><div class="panel-title-dot" style="background:var(--yellow)"></div>ÚLTIMOS SINAIS</div><button class="btn" style="font-size:9px;padding:3px 8px;" onclick="manualRefresh()">↻ ATUALIZAR</button></div>
        <div id="historyList">
          <div style="padding:18px;text-align:center;font-size:10px;color:var(--text3);font-family:'Space Mono',monospace;">Conectando ao backend...</div>
        </div>
      </div>
      <div class="panel" style="grid-column:2/4;">
        <div class="panel-header"><div class="panel-title"><div class="panel-title-dot" style="background:var(--orange)"></div>ALERTAS DO WEBHOOK</div></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:9px;">
        <div id="alertsFeed" style="display:grid;grid-template-columns:1fr 1fr;gap:9px;grid-column:1/-1;">
            <div style="padding:18px;text-align:center;font-size:10px;color:var(--text3);font-family:'Space Mono',monospace;grid-column:1/-1;">Aguardando sinais do TradingView...</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ══ SETTINGS ══ -->
<div class="view" id="view-settings">
  <div class="container">
    <div class="settings-grid">
      <div class="settings-card" style="grid-column:1/-1;">
        <div class="settings-card-header">
          <div class="settings-card-title"><span style="color:var(--green);">⚙</span> CONFIGURAÇÃO DE ATIVOS & TIMEFRAMES</div>
          <button class="btn btn-add" onclick="showAddRow()">+ NOVO ATIVO</button>
        </div>
        <div class="asset-config-row header">
          <span>ATIVO</span><span>TF PRINCIPAL</span><span>TF CONFIRMAÇÃO</span><span>TF ENTRADA</span><span>SCORE MÍN.</span><span>ON/OFF</span>
        </div>
        <div id="assetConfigRows"></div>
        <div class="add-asset-row" id="addRow" style="display:none;">
          <input type="text" id="newAssetInput" placeholder="Ex: GBP/JPY, SILVER, RTY1!" />
          <select class="config-select" id="newClass" style="width:120px;"><option>Crypto</option><option>Forex</option><option>Índice</option><option>Commodity</option></select>
          <button class="btn btn-add" onclick="addAsset()">CONFIRMAR</button>
          <button class="btn" onclick="document.getElementById('addRow').style.display='none'">CANCELAR</button>
        </div>
      </div>

      <div class="settings-card">
        <div class="settings-card-header"><div class="settings-card-title"><span style="color:var(--blue);">◈</span> CONFIGURAÇÕES GERAIS</div></div>
        <div class="global-setting-row"><div><div class="global-setting-label">Score mínimo para acionar Claude</div><div class="global-setting-sub">abaixo disso apenas registra no dashboard</div></div><input class="config-input" type="number" value="3" min="1" max="5" style="width:50px;text-align:center;"></div>
        <div class="global-setting-row"><div><div class="global-setting-label">Exigir alinhamento de TFs</div><div class="global-setting-sub">principal + confirmação devem coincidir</div></div><button class="toggle on" onclick="this.classList.toggle('on')"></button></div>
        <div class="global-setting-row"><div><div class="global-setting-label">Weekend Mode automático</div><div class="global-setting-sub">detecta sex–dom e amplia stops</div></div><button class="toggle on" onclick="this.classList.toggle('on')"></button></div>
        <div class="global-setting-row"><div><div class="global-setting-label">Disparar Telegram automaticamente</div><div class="global-setting-sub">envia ao canal quando score atingido</div></div><button class="toggle" onclick="this.classList.toggle('on')"></button></div>
        <div class="global-setting-row"><div><div class="global-setting-label">Canal Telegram</div></div><input class="config-input" type="text" value="@meu_canal" style="width:130px;"></div>
      </div>

      <div class="settings-card">
        <div class="settings-card-header"><div class="settings-card-title"><span style="color:var(--yellow);">◈</span> PRESETS DE TF POR CLASSE</div><span style="font-size:8px;color:var(--text3);font-family:'Space Mono',monospace;">aplicar em lote</span></div>
        <div id="presetRows"></div>
        <div style="margin-top:12px;padding-top:10px;border-top:1px solid var(--border);font-size:8px;color:var(--text3);font-family:'Space Mono',monospace;line-height:1.7;">
          Presets aplicam o padrão para todos os ativos da classe.<br>Config individuais sempre sobrescrevem o preset.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ══ HISTORY ══ -->
<div class="view" id="view-history">
  <div class="container" style="padding:16px 24px;">
    <div class="panel">
      <div class="panel-header"><div class="panel-title"><div class="panel-title-dot" style="background:var(--yellow)"></div>HISTÓRICO COMPLETO</div><div class="flex-row"><select class="config-select" style="width:90px;"><option>Todos</option><option>BUY</option><option>SELL</option></select><select class="config-select" style="width:120px;"><option>Todos ativos</option><option>BTC/USDT</option></select></div></div>
      <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:9px;margin-bottom:14px;">
        <div style="padding:13px;background:var(--bg3);border:1px solid var(--border);text-align:center;"><div style="font-size:20px;font-weight:800;font-family:'Space Mono',monospace;color:var(--green);">73%</div><div style="font-size:8px;color:var(--text3);margin-top:3px;font-family:'Space Mono',monospace;">WIN RATE</div></div>
        <div style="padding:13px;background:var(--bg3);border:1px solid var(--border);text-align:center;"><div style="font-size:20px;font-weight:800;font-family:'Space Mono',monospace;">47</div><div style="font-size:8px;color:var(--text3);margin-top:3px;font-family:'Space Mono',monospace;">TOTAL TRADES</div></div>
        <div style="padding:13px;background:var(--bg3);border:1px solid var(--border);text-align:center;"><div style="font-size:20px;font-weight:800;font-family:'Space Mono',monospace;color:var(--green);">2.4</div><div style="font-size:8px;color:var(--text3);margin-top:3px;font-family:'Space Mono',monospace;">PROFIT FACTOR</div></div>
        <div style="padding:13px;background:var(--bg3);border:1px solid var(--border);text-align:center;"><div style="font-size:20px;font-weight:800;font-family:'Space Mono',monospace;color:var(--green);">+0.31R</div><div style="font-size:8px;color:var(--text3);margin-top:3px;font-family:'Space Mono',monospace;">EXPECTATIVA</div></div>
        <div style="padding:13px;background:var(--bg3);border:1px solid var(--border);text-align:center;"><div style="font-size:20px;font-weight:800;font-family:'Space Mono',monospace;color:var(--blue);">34/13</div><div style="font-size:8px;color:var(--text3);margin-top:3px;font-family:'Space Mono',monospace;">WIN / LOSS</div></div>
      </div>
      <div style="font-size:10px;color:var(--text2);font-family:'Space Mono',monospace;padding:18px;text-align:center;border:1px dashed var(--border);">Histórico detalhado disponível após integração com o backend.<br>Os trades serão registrados automaticamente via webhook.</div>
    </div>
  </div>
</div>

<script>
// ══════════════════════════════════════════════════════
// APEX HUB — Frontend v2.0 — Conectado ao Railway
// ══════════════════════════════════════════════════════

const API_URL = 'https://web-production-947e32.up.railway.app';
const POLL_INTERVAL = 15000; // 15s

// ── Busca stats globais e exibe no header
async function fetchStats() {
  try {
    const res = await fetch(`${API_URL}/api/stats`, {signal: AbortSignal.timeout(6000)});
    if (!res.ok) return;
    const data = await res.json();
    const el = document.getElementById('globalStats');
    if (el) el.textContent = `${data.total} sinais · ${data.assets?.length || 0} ativos · Prob média ${data.avg_prob}%`;
  } catch(e) {}
}

const TF_OPT = ['1m','3m','5m','15m','30m','1H','2H','4H','6H','12H','1D','1W'];
const CLASSES = ['Crypto','Forex','Índice','Commodity'];

// ── Estado da conexão
let connectionStatus = 'connecting'; // connecting | online | offline
let lastSignals = []; // cache dos últimos sinais do backend
let activeSignal = null; // sinal ativo no dashboard
let pollTimer = null;

let assets = [
  {id:1,name:'BTC/USDT',cls:'Crypto',   tf_p:'4H', tf_c:'1H', tf_e:'15m',score:3,on:true, bias:'neutral'},
  {id:2,name:'ETH/USDT',cls:'Crypto',   tf_p:'4H', tf_c:'1H', tf_e:'15m',score:3,on:true, bias:'neutral'},
  {id:3,name:'EUR/USD', cls:'Forex',    tf_p:'4H', tf_c:'1H', tf_e:'15m',score:3,on:true, bias:'neutral'},
  {id:4,name:'GBP/USD', cls:'Forex',    tf_p:'4H', tf_c:'1H', tf_e:'15m',score:3,on:true, bias:'neutral'},
  {id:5,name:'USD/JPY', cls:'Forex',    tf_p:'4H', tf_c:'1H', tf_e:'15m',score:3,on:true, bias:'neutral'},
  {id:6,name:'AUD/USD', cls:'Forex',    tf_p:'4H', tf_c:'1H', tf_e:'15m',score:3,on:false,bias:'neutral'},
  {id:7,name:'USD/CAD', cls:'Forex',    tf_p:'4H', tf_c:'1H', tf_e:'15m',score:3,on:false,bias:'neutral'},
  {id:8,name:'USD/CHF', cls:'Forex',    tf_p:'4H', tf_c:'1H', tf_e:'15m',score:3,on:false,bias:'neutral'},
  {id:9,name:'XAU/USD', cls:'Commodity',tf_p:'4H', tf_c:'1H', tf_e:'15m',score:3,on:true, bias:'neutral'},
  {id:10,name:'SP500',  cls:'Índice',   tf_p:'1H', tf_c:'15m',tf_e:'5m', score:3,on:true, bias:'neutral'},
  {id:11,name:'NQ100',  cls:'Índice',   tf_p:'1H', tf_c:'15m',tf_e:'5m', score:3,on:true, bias:'neutral'},
  {id:12,name:'DJ30',   cls:'Índice',   tf_p:'1H', tf_c:'15m',tf_e:'5m', score:3,on:true, bias:'neutral'},
];

let presets = {
  'Crypto':    {tf_p:'4H', tf_c:'1H',  tf_e:'15m'},
  'Forex':     {tf_p:'4H', tf_c:'1H',  tf_e:'15m'},
  'Índice':    {tf_p:'1H', tf_c:'15m', tf_e:'5m'},
  'Commodity': {tf_p:'4H', tf_c:'1H',  tf_e:'15m'},
};

let activeId = 1;

function tfSelect(val, onChange) {
  return `<select class="config-select" onchange="${onChange}">${TF_OPT.map(t=>`<option${t===val?' selected':''}>${t}</option>`).join('')}</select>`;
}

// ── ASSET BAR ──
function renderAssetBar() {
  const bar = document.getElementById('assetBar');
  bar.innerHTML = assets.filter(a=>a.on).map(a => {
    const bc = a.bias==='bull'?'badge-bull':a.bias==='bear'?'badge-bear':'badge-neutral';
    const bt = a.bias==='bull'?'BUY':a.bias==='bear'?'SELL':'–';
    const ac = a.id===activeId?(a.bias==='bear'?'active bear':'active'):'';
    return `<div class="asset-pill ${ac}" onclick="selectAsset(${a.id})">${a.name}<span class="asset-badge ${bc}">${bt}</span><span class="tf-mini">${a.tf_p}</span></div>`;
  }).join('');
}

function selectAsset(id) { activeId=id; renderAssetBar(); updateDashboard(); }

// ── DASHBOARD (legado — só renderiza estrutura se não houver sinal real)
function updateDashboard() {
  const a = assets.find(x=>x.id===activeId);
  if(!a) return;
  document.getElementById('signalPanelTitle').textContent = `ANÁLISE ATIVA — ${a.name}`;
  document.getElementById('heroTFP').textContent = a.tf_p;
  document.getElementById('heroTFC').textContent = a.tf_c+' ✓';
  document.getElementById('heroTFE').textContent = a.tf_e;
  document.getElementById('indTFLabel').textContent = `Principal: ${a.tf_p}`;
  document.getElementById('signalTFTag').textContent = `${a.tf_p} · AGUARDANDO`;

  const tfData = [
    {role:'PRINCIPAL',   tf:a.tf_p, score:'—', status:'AGUARD.', cls:'neutral'},
    {role:'CONFIRMAÇÃO', tf:a.tf_c, score:'—', status:'AGUARD.', cls:'neutral'},
    {role:'ENTRADA',     tf:a.tf_e, score:'—', status:'AGUARD.', cls:'neutral'},
  ];

  document.getElementById('tfAlignment').innerHTML = tfData.map(t=>`
    <div class="tf-col ${t.cls}">
      <div class="tf-col-role">${t.role}</div>
      <div class="tf-col-tf" style="color:var(--text2)">${t.tf}</div>
      <div class="tf-col-score">${t.score}</div>
      <div class="tf-col-status" style="color:var(--text3)">${t.status}</div>
    </div>`).join('');

  document.getElementById('alignDots').innerHTML = tfData.map(()=>
    `<div class="alignment-dot" style="background:var(--text3)"></div>`
  ).join('');

  document.getElementById('alignResult').textContent = '—';
  document.getElementById('alignResult').style.color = 'var(--text3)';
  document.getElementById('alignTag').textContent = 'AGUARDANDO SINAL';
  document.getElementById('alignTag').className = 'tag tag-yellow';

  ['ind1','ind2','ind3','ind4','ind5'].forEach(id=>{
    document.getElementById(id).innerHTML = tfData.map((t,i)=>
      `<div class="ind-tf-badge ${i===0?'active-tf':''}">${t.tf}</div>`
    ).join('');
  });

  // Se o ativo tem sinal cacheado, renderiza
  if (a.latestSignal) {
    renderSignalFromBackend(a.latestSignal);
  } else {
    const btn = document.getElementById('analyzeBtn');
    if(btn){ btn.className='analyze-btn blocked'; btn.innerHTML='<span>⚠ AGUARDANDO SINAL DO INDICADOR</span>'; }
  }
}
  document.getElementById('indTFLabel').textContent = `Principal: ${a.tf_p}`;
  document.getElementById('signalTFTag').textContent = `${a.tf_p} · OB SELL`;

  const tfData = [
    {role:'PRINCIPAL',   tf:a.tf_p, score:'4/5', status:a.bias==='bear'?'BEAR':'BULL', cls:a.bias==='bear'?'bear':'bull'},
    {role:'CONFIRMAÇÃO', tf:a.tf_c, score:'3/5', status:a.bias==='bear'?'BEAR':'BULL', cls:a.bias==='bear'?'bear':'bull'},
    {role:'ENTRADA',     tf:a.tf_e, score:'2/5', status:'NEUTRO', cls:'neutral'},
  ];

  document.getElementById('tfAlignment').innerHTML = tfData.map(t=>`
    <div class="tf-col ${t.cls}">
      <div class="tf-col-role">${t.role}</div>
      <div class="tf-col-tf" style="color:${t.cls==='bear'?'var(--red)':t.cls==='bull'?'var(--green)':'var(--text2)'}">${t.tf}</div>
      <div class="tf-col-score">${t.score}</div>
      <div class="tf-col-status" style="color:${t.cls==='bear'?'var(--red)':t.cls==='bull'?'var(--green)':'var(--text3)'}">${t.status}</div>
    </div>`).join('');

  document.getElementById('alignDots').innerHTML = tfData.map(t=>
    `<div class="alignment-dot" style="background:${t.cls==='bear'?'var(--red)':t.cls==='bull'?'var(--green)':'var(--text3)'}"></div>`
  ).join('');

  const aligned = tfData[0].cls===tfData[1].cls;
  document.getElementById('alignResult').textContent = aligned?'2/2 ✓':'1/2 ✗';
  document.getElementById('alignResult').style.color = aligned?'var(--green)':'var(--yellow)';
  document.getElementById('alignTag').textContent = aligned?`ALINHADO ${a.bias.toUpperCase()}`:'DIVERGÊNCIA';
  document.getElementById('alignTag').className = `tag ${aligned?(a.bias==='bear'?'tag-red':'tag-green'):'tag-yellow'}`;

  ['ind1','ind2','ind3','ind4','ind5'].forEach(id=>{
    document.getElementById(id).innerHTML = tfData.map((t,i)=>
      `<div class="ind-tf-badge ${i===0?'active-tf':''} ${t.cls==='bear'?'bear-tf':t.cls==='bull'?'bull-tf':''}">${t.tf}</div>`
    ).join('');
  });

  const btn = document.getElementById('analyzeBtn');
  if(aligned){ btn.className='analyze-btn'; btn.innerHTML='<span>⚡ ACIONAR ANÁLISE APEX</span>'; }
  else { btn.className='analyze-btn blocked'; btn.innerHTML='<span>⚠ AGUARDAR ALINHAMENTO DE TFs</span>'; }
}

// ── SETTINGS ROWS ──
function renderSettingsRows() {
  document.getElementById('assetConfigRows').innerHTML = assets.map(a=>`
    <div class="asset-config-row">
      <div class="asset-name-cell">${a.name}<br><span style="font-size:7px;color:var(--text3);font-weight:400;">${a.cls}</span></div>
      ${tfSelect(a.tf_p,`setTF(${a.id},'tf_p',this.value)`)}
      ${tfSelect(a.tf_c,`setTF(${a.id},'tf_c',this.value)`)}
      ${tfSelect(a.tf_e,`setTF(${a.id},'tf_e',this.value)`)}
      <input class="config-input" type="number" value="${a.score}" min="1" max="5" style="text-align:center;" onchange="setTF(${a.id},'score',+this.value)">
      <div class="toggle-wrap"><button class="toggle ${a.on?'on':''}" onclick="toggleA(${a.id},this)"></button></div>
    </div>`).join('');

  document.getElementById('presetRows').innerHTML = CLASSES.map(cls=>{
    const p = presets[cls];
    return `<div class="global-setting-row">
      <div><div class="global-setting-label">${cls}</div></div>
      <div class="global-setting-ctrl" style="gap:5px;">
        ${tfSelect(p.tf_p,`presets['${cls}'].tf_p=this.value`)}
        ${tfSelect(p.tf_c,`presets['${cls}'].tf_c=this.value`)}
        ${tfSelect(p.tf_e,`presets['${cls}'].tf_e=this.value`)}
        <button class="btn" style="font-size:8px;padding:4px 7px;" onclick="applyPreset('${cls}')">APLICAR</button>
      </div>
    </div>`;
  }).join('');
}

function setTF(id, field, val) {
  const a = assets.find(x=>x.id===id);
  if(a){ a[field]=val; renderAssetBar(); if(id===activeId) updateDashboard(); }
}

function toggleA(id, btn) {
  const a = assets.find(x=>x.id===id);
  if(a){ a.on=!a.on; btn.classList.toggle('on'); renderAssetBar(); }
}

function applyPreset(cls) {
  const p = presets[cls];
  assets.filter(a=>a.cls===cls).forEach(a=>{ a.tf_p=p.tf_p; a.tf_c=p.tf_c; a.tf_e=p.tf_e; });
  renderSettingsRows(); renderAssetBar();
  if(assets.find(x=>x.id===activeId)?.cls===cls) updateDashboard();
}

function showAddRow() { document.getElementById('addRow').style.display='flex'; document.getElementById('newAssetInput').focus(); }

function addAsset() {
  const name = document.getElementById('newAssetInput').value.trim().toUpperCase();
  const cls  = document.getElementById('newClass').value;
  if(!name) return;
  const p = presets[cls]||{tf_p:'4H',tf_c:'1H',tf_e:'15m'};
  assets.push({id:Date.now(),name,cls,tf_p:p.tf_p,tf_c:p.tf_c,tf_e:p.tf_e,score:3,on:true,bias:'neutral'});
  document.getElementById('newAssetInput').value='';
  document.getElementById('addRow').style.display='none';
  renderSettingsRows(); renderAssetBar();
}

// ── VIEWS ──
function showView(name, btn) {
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById('view-'+name).classList.add('active');
  document.querySelectorAll('.header-actions .btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  if(name==='settings') renderSettingsRows();
}

// ══════════════════════════════════════════════════════
// INTEGRAÇÃO COM RAILWAY
// ══════════════════════════════════════════════════════

// Atualiza o indicador de status de conexão no header
function setConnectionStatus(status) {
  connectionStatus = status;
  const dot = document.getElementById('connectionDot');
  const label = document.getElementById('connectionLabel');
  if (!dot || !label) return;
  if (status === 'online') {
    dot.style.background = 'var(--green)'; label.textContent = 'BACKEND ONLINE';
  } else if (status === 'offline') {
    dot.style.background = 'var(--red)'; label.textContent = 'BACKEND OFFLINE';
  } else {
    dot.style.background = 'var(--yellow)'; label.textContent = 'CONECTANDO...';
  }
}

// Busca sinais do Railway
async function fetchSignals() {
  try {
    const res = await fetch(`${API_URL}/signals?limit=50`, {signal: AbortSignal.timeout(8000)});
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    setConnectionStatus('online');
    return data.signals || [];
  } catch (e) {
    setConnectionStatus('offline');
    return null;
  }
}

// Aplica sinais recebidos aos assets e atualiza o dashboard
function applySignalsToAssets(signals) {
  if (!signals || !signals.length) return;
  lastSignals = signals;

  // Para cada ativo, pega o sinal mais recente
  assets.forEach(a => {
    const sig = signals.find(s => s.asset === a.name);
    if (sig) {
      a.bias = sig.direction === 'buy' ? 'bull' : sig.direction === 'sell' ? 'bear' : 'neutral';
      a.latestSignal = sig;
    }
  });

  renderAssetBar();

  // Se o ativo ativo tem sinal novo, atualiza o dashboard
  const active = assets.find(x => x.id === activeId);
  if (active?.latestSignal) {
    renderSignalFromBackend(active.latestSignal);
  }

  // Atualiza a feed de alertas
  renderAlertsFeed(signals.slice(0, 8));

  // Atualiza histórico
  renderHistoryFromSignals(signals);
}

// Renderiza o painel principal com dados reais do sinal
function renderSignalFromBackend(sig) {
  if (!sig) return;
  activeSignal = sig;
  let payload = {};
  try { payload = JSON.parse(sig.payload || '{}'); } catch(e){}
  let analysis = {};
  try { analysis = JSON.parse(sig.analysis || '{}'); } catch(e){}

  const direction = sig.direction || 'neutral';
  const score = sig.score || 0;
  const asset = sig.asset || '';
  const lvl = payload.levels || {};
  const fib = payload.fibonacci || {};
  const sd = payload.sd_zones || {};
  const keo = payload.keo || {};
  const mm = payload.mm_kernel || {};
  const osc = payload.osc_matrix || {};
  const st = payload.stoch_rsi || {};
  const pr = payload.price || {};
  const scr = payload.score || {};
  const tfs = payload.timeframes || {};
  const isWeekend = payload.is_weekend || sig.is_weekend;
  const pathClear = payload.signal?.path_clear || false;
  const prob = analysis.probabilidade || sig.prob || 0;

  // Badge direcional
  const isBull = direction === 'buy';
  const isBear = direction === 'sell';
  const dirLabel = isBull ? 'BUY' : isBear ? 'SELL' : 'NEUTRO';
  const dirColor = isBull ? 'var(--green)' : isBear ? 'var(--red)' : 'var(--text2)';
  const heroClass = isBull ? 'bull' : isBear ? 'bear' : '';

  // Panel title
  const signalPanelTitle = document.getElementById('signalPanelTitle');
  if (signalPanelTitle) signalPanelTitle.textContent = `ANÁLISE ATIVA — ${asset}`;

  // Hero TFs
  const el = (id, val) => { const e = document.getElementById(id); if(e) e.textContent = val; };
  el('heroTFP', tfs.principal || '4H');
  el('heroTFC', (tfs.confirmacao || '1H') + ' ✓');
  el('heroTFE', tfs.entrada || '15m');

  // Signal hero
  const hero = document.getElementById('signalHero');
  if (hero) {
    hero.className = `signal-hero ${heroClass}`;
    document.getElementById('signalBadge').className = `signal-badge ${direction}`;
    document.getElementById('signalBadge').textContent = dirLabel;
    document.getElementById('signalAsset').textContent = asset;
    document.getElementById('signalScore').innerHTML = `Score <strong>${score}/5</strong>`;
    document.getElementById('signalTFTag').textContent = `${tfs.principal || '4H'} · ${sd.zone_type?.toUpperCase() || 'OB'} ${dirLabel}`;
    document.getElementById('currentPrice').textContent = pr.close ? pr.close.toLocaleString('pt-BR', {minimumFractionDigits:2}) : '—';
    document.getElementById('signalProbTag').style.display = prob ? 'inline-block' : 'none';
    document.getElementById('signalProbTag').textContent = `PROB ${prob}%`;
    document.getElementById('signalPathTag').style.display = pathClear ? 'inline-block' : 'none';
    if (isWeekend) {
      const wk = document.getElementById('weekendBadge');
      if (wk) wk.style.display = 'flex';
    }
  }

  // Níveis
  const f2 = v => v ? (+v).toLocaleString('pt-BR', {minimumFractionDigits:2}) : '—';
  el('levelEntry', f2(lvl.entry || sig.entry));
  el('levelStop',  f2(lvl.stop  || sig.stop));
  el('levelTP1',   f2(lvl.tp1   || sig.tp1));
  el('levelTP2',   f2(lvl.tp2   || sig.tp2));
  el('levelTP3',   f2(lvl.tp3   || sig.tp3));

  // R/R
  const rr = analysis.tabela_alvos?.rr_ratio || '—';
  el('levelRR', typeof rr === 'number' ? rr.toFixed(2) : rr);

  // TF Alignment
  const tfData = [
    {role:'PRINCIPAL',   tf: tfs.principal||'4H', score: `${scr.total||score}/5`, status: isBear?'BEAR':isBull?'BULL':'NEUTRO', cls: isBear?'bear':isBull?'bull':'neutral'},
    {role:'CONFIRMAÇÃO', tf: tfs.confirmacao||'1H', score: `${scr.total||score}/5`, status: isBear?'BEAR':isBull?'BULL':'NEUTRO', cls: isBear?'bear':isBull?'bull':'neutral'},
    {role:'ENTRADA',     tf: tfs.entrada||'15m', score:'—', status:'NEUTRO', cls:'neutral'},
  ];
  const tfAlign = document.getElementById('tfAlignment');
  if (tfAlign) tfAlign.innerHTML = tfData.map(t=>`
    <div class="tf-col ${t.cls}">
      <div class="tf-col-role">${t.role}</div>
      <div class="tf-col-tf" style="color:${t.cls==='bear'?'var(--red)':t.cls==='bull'?'var(--green)':'var(--text2)'}">${t.tf}</div>
      <div class="tf-col-score">${t.score}</div>
      <div class="tf-col-status" style="color:${t.cls==='bear'?'var(--red)':t.cls==='bull'?'var(--green)':'var(--text3)'}">${t.status}</div>
    </div>`).join('');

  const alignDots = document.getElementById('alignDots');
  if (alignDots) alignDots.innerHTML = tfData.map(t=>
    `<div class="alignment-dot" style="background:${t.cls==='bear'?'var(--red)':t.cls==='bull'?'var(--green)':'var(--text3)'}"></div>`
  ).join('');

  const aligned = tfData[0].cls === tfData[1].cls && tfData[0].cls !== 'neutral';
  el('alignResult', aligned ? '2/2 ✓' : '1/2 ✗');
  const alignResultEl = document.getElementById('alignResult');
  if (alignResultEl) alignResultEl.style.color = aligned ? 'var(--green)' : 'var(--yellow)';
  el('alignTag', aligned ? `ALINHADO ${dirLabel}` : 'DIVERGÊNCIA');
  const alignTagEl = document.getElementById('alignTag');
  if (alignTagEl) alignTagEl.className = `tag ${aligned?(isBear?'tag-red':'tag-green'):'tag-yellow'}`;

  // Score individual
  el('scoreNumber', score);
  el('scoreLabel', `DE 5 · ${dirLabel}`);
  const scoreBar = document.getElementById('scoreBarFill');
  if (scoreBar) {
    scoreBar.style.width = `${score*20}%`;
    scoreBar.style.background = score >= 4 ? 'var(--green)' : score === 3 ? 'var(--yellow)' : 'var(--red)';
  }
  const scoreColor = score >= 4 ? 'var(--green)' : score === 3 ? 'var(--yellow)' : 'var(--red)';
  const scoreNum = document.getElementById('scoreNumber');
  if (scoreNum) scoreNum.style.color = scoreColor;

  // Score items
  const scoreItems = [
    ['SD Zone', scr.sd, sd.zone_type || '—'],
    ['KEO v7',  scr.keo, payload.signal?.type || '—'],
    ['MM Kernel', scr.mm_kernel, mm.status || '—'],
    ['Osc Matrix', scr.osc_matrix, osc.confluence ? osc.confluence.toFixed(2) : '—'],
    ['Stoch RSI', scr.stoch_rsi, `K:${(st.k||0).toFixed(1)}`],
  ];
  const scoreItemsEl = document.getElementById('scoreItems');
  if (scoreItemsEl) scoreItemsEl.innerHTML = scoreItems.map(([label, val, sub])=>
    `<div class="score-item">
      <div><div class="score-item-label">${label}</div><div style="font-size:7px;color:var(--text3);font-family:'Space Mono',monospace;margin-top:1px;">${sub}</div></div>
      <div class="score-item-val" style="color:${val?'var(--green)':'var(--text3)'}">${val ? '✓' : '–'}</div>
    </div>`
  ).join('');

  // Probabilidade gauge
  el('probValue', prob ? `${prob}%` : '—');
  const probFill = document.getElementById('probFill');
  if (probFill) {
    probFill.style.width = `${prob}%`;
    probFill.style.background = prob >= 70 ? 'var(--green)' : prob >= 50 ? 'var(--yellow)' : 'var(--red)';
  }

  // Análise Claude
  if (analysis && !analysis.error) {
    el('analysisEstrutura', analysis.estrutura_smc || '—');
    el('analysisMicro', analysis.microestrutura || '—');
    el('analysisRisco', analysis.gestao_risco || '—');

    const confList = document.getElementById('confluenceList');
    if (confList) confList.innerHTML = (analysis.confluencias || []).map(c=>
      `<div style="padding:5px 0;border-bottom:1px solid var(--border);font-size:10px;color:var(--text2);display:flex;align-items:flex-start;gap:7px;"><span style="color:var(--green);margin-top:1px;">▸</span>${c}</div>`
    ).join('') || '<div style="color:var(--text3);font-size:10px;">Aguardando análise...</div>';

    const alertList = document.getElementById('alertsList');
    if (alertList) alertList.innerHTML = (analysis.alertas || []).map(a=>
      `<div style="padding:5px 0;border-bottom:1px solid var(--border);font-size:10px;color:var(--text2);display:flex;align-items:flex-start;gap:7px;"><span style="color:var(--yellow);margin-top:1px;">⚠</span>${a}</div>`
    ).join('') || '';

    el('tgContent', analysis.resumo_telegram || '—');

    // Indicadores individuais
    const indData = [
      {id:'indStatus1', label:'SD Zones', val: scr.sd ? '✓ ATIVO' : '– INATIVO', ok: !!scr.sd, metric: `Zone: ${sd.zone_type||'none'}`},
      {id:'indStatus2', label:'KEO v7',   val: scr.keo ? `✓ ${(payload.signal?.type||'—').toUpperCase()}` : '– INATIVO', ok: !!scr.keo, metric: `ER: ${(keo.er_kaufman||0).toFixed(2)}`},
      {id:'indStatus3', label:'MM Kernel',val: scr.mm_kernel ? `✓ ${mm.status||'—'}` : '– INATIVO', ok: !!scr.mm_kernel, metric: `ADX: ${(mm.adx||0).toFixed(1)}`},
      {id:'indStatus4', label:'Osc Matrix',val: scr.osc_matrix ? '✓ CONFLUENTE' : '– INATIVO', ok: !!scr.osc_matrix, metric: `MF: ${(osc.money_flow||0).toFixed(2)}`},
      {id:'indStatus5', label:'Stoch RSI',val: scr.stoch_rsi ? '✓ ARMADO' : '– INATIVO', ok: !!scr.stoch_rsi, metric: `K:${(st.k||0).toFixed(1)} D:${(st.d||0).toFixed(1)}`},
    ];
    indData.forEach(({id, val, ok, metric}) => {
      const el2 = document.getElementById(id);
      if (el2) { el2.textContent = val; el2.style.color = ok ? 'var(--green)' : 'var(--text3)'; }
      const metricId = id.replace('indStatus','indMetric');
      const metricEl = document.getElementById(metricId);
      if (metricEl) metricEl.textContent = metric;
    });
  }

  // Botão analisar
  const btn = document.getElementById('analyzeBtn');
  if (btn) {
    if (aligned) {
      btn.className = 'analyze-btn';
      btn.innerHTML = '<span>⚡ ACIONAR ANÁLISE APEX</span>';
    } else {
      btn.className = 'analyze-btn blocked';
      btn.innerHTML = '<span>⚠ AGUARDAR ALINHAMENTO DE TFs</span>';
    }
  }

  // TF label
  el('indTFLabel', `Principal: ${tfs.principal || '4H'}`);
}

// Feed de alertas lateral com dados reais
function renderAlertsFeed(signals) {
  const feed = document.getElementById('alertsFeed');
  if (!feed) return;
  if (!signals.length) {
    feed.innerHTML = '<div style="padding:18px;text-align:center;font-size:10px;color:var(--text3);font-family:\'Space Mono\',monospace;grid-column:1/-1;">Aguardando sinais do TradingView...</div>';
    return;
  }
  feed.innerHTML = signals.map(s => {
    const dir = s.direction || 'neutral';
    const isBull = dir === 'buy';
    const isBear = dir === 'sell';
    const emoji = isBull ? '🟢' : isBear ? '🔴' : '⚪';
    const cls = isBull ? 'premium' : isBear ? 'warning' : 'info';
    const ts = s.timestamp ? new Date(s.timestamp).toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'}) : '—';
    let analysis = {};
    try { analysis = JSON.parse(s.analysis || '{}'); } catch(e) {}
    const prob = analysis.probabilidade || s.prob || 0;
    return `<div class="alert-item ${cls}" style="cursor:pointer;" onclick="loadSignalById(${s.id})">
      <div class="alert-title">${emoji} ${(dir).toUpperCase()} — ${s.asset || '?'}</div>
      <div class="alert-desc">Score ${s.score}/5${prob ? ` · Prob ${prob}%` : ''}</div>
      <div class="alert-time">${ts}</div>
    </div>`;
  }).join('');
}

// Clique em um alerta carrega aquele sinal no dashboard
function loadSignalById(id) {
  const sig = lastSignals.find(s => s.id === id);
  if (!sig) return;
  activeSignal = sig;
  const assetName = sig.asset;
  const assetObj = assets.find(a => a.name === assetName);
  if (assetObj) { activeId = assetObj.id; renderAssetBar(); }
  renderSignalFromBackend(sig);
}

// Histórico com dados reais
function renderHistoryFromSignals(signals) {
  const container = document.getElementById('historyList');
  if (!container) return;
  if (!signals.length) {
    container.innerHTML = '<div style="padding:18px;text-align:center;font-size:10px;color:var(--text3);font-family:\'Space Mono\',monospace;">Nenhum histórico ainda.</div>';
    return;
  }
  container.innerHTML = signals.slice(0, 20).map(s => {
    const dir = s.direction || '?';
    const isBull = dir === 'buy';
    const ts = s.timestamp ? new Date(s.timestamp).toLocaleDateString('pt-BR') + ' ' + new Date(s.timestamp).toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'}) : '—';
    let analysis = {}; try { analysis = JSON.parse(s.analysis || '{}'); } catch(e){}
    const prob = analysis.probabilidade || s.prob || 0;
    return `<div class="history-item" style="cursor:pointer;" onclick="loadSignalById(${s.id})">
      <div class="history-dir" style="background:${isBull?'rgba(0,229,160,0.1)':'rgba(255,77,109,0.1)'};color:${isBull?'var(--green)':'var(--red)'};">${dir.toUpperCase()}</div>
      <div class="history-info">
        <div class="history-asset">${s.asset}</div>
        <div class="history-tf" style="font-size:7px;">${ts}</div>
      </div>
      <div class="history-result" style="color:var(--text2);">Score ${s.score}/5${prob ? `<br><span style='color:var(--blue);'>Prob ${prob}%</span>` : ''}</div>
    </div>`;
  }).join('');
}

// ── Polling automático
async function pollBackend() {
  const signals = await fetchSignals();
  if (signals) applySignalsToAssets(signals);
  pollTimer = setTimeout(pollBackend, POLL_INTERVAL);
}

// ── Trigger análise manual (já existe análise salva no sinal, apenas exibe)
function triggerAnalysis() {
  const btn = document.getElementById('analyzeBtn');
  if (btn && btn.classList.contains('blocked')) return;

  if (activeSignal) {
    btn.classList.add('loading');
    btn.innerHTML = '<span>⟳ CARREGANDO ANÁLISE APEX...</span>';
    setTimeout(() => {
      renderSignalFromBackend(activeSignal);
      btn.classList.remove('loading');
      btn.innerHTML = '<span>✓ ANÁLISE CARREGADA</span>';
      setTimeout(() => btn.innerHTML = '<span>⚡ ACIONAR ANÁLISE APEX</span>', 2500);
    }, 800);
  } else {
    btn.innerHTML = '<span>⚠ NENHUM SINAL ATIVO</span>';
    setTimeout(() => btn.innerHTML = '<span>⚡ ACIONAR ANÁLISE APEX</span>', 2000);
  }
}

// ══════════════════════════════════════════════════════
// FUNÇÕES EXISTENTES (mantidas)
// ══════════════════════════════════════════════════════

// ── TELEGRAM ──
function copyTG() {
  navigator.clipboard.writeText(document.getElementById('tgContent').innerText).then(()=>{
    const b=document.querySelector('.tg-copy-btn'); b.textContent='COPIADO!'; setTimeout(()=>b.textContent='COPIAR',2000);
  });
}

// ── CLOCK ──
function tick() {
  const n=new Date();
  const M=['JAN','FEV','MAR','ABR','MAI','JUN','JUL','AGO','SET','OUT','NOV','DEZ'];
  document.getElementById('clock').textContent=`${String(n.getUTCDate()).padStart(2,'0')} ${M[n.getUTCMonth()]} ${n.getUTCFullYear()} — ${String(n.getUTCHours()).padStart(2,'0')}:${String(n.getUTCMinutes()).padStart(2,'0')} UTC`;
}

// ── INIT ──
renderAssetBar();
updateDashboard();
tick();
setInterval(tick, 30000);

// Inicia conexão com Railway
setConnectionStatus('connecting');
pollBackend();
fetchStats();
setInterval(fetchStats, 60000); // atualiza stats a cada 1min

// ── Atalho manual: recarregar sinais
function manualRefresh() {
  setConnectionStatus('connecting');
  clearTimeout(pollTimer);
  pollBackend();
}
</script>
</body>
</html>
